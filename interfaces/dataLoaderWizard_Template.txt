%% Define input file
% 2 h5oina files
% first one has EBSD map data
% second one has images

dataPath = "<dataPath>";

%% Load EBSD map from first h5oina file
orig_state = warning; warning off; % suppress h5oina coordinate convention warning
ebsd = gridify(...
    rotate(...
    loadEBSD_h5oina('<str_ebsdFile>'),...
    reflection(xvector),'keepXY'));
ext = ebsd.extent; ebsd = ebsd - (ext(1)*xvector)  - (ext(3)*yvector)  - (ext(5)*zvector);

pC = plottingConvention(-vector3d.Z,vector3d.X); pC.makeDefault;
ebsd.how2plot = pC;
disp("Assume typical plotting convention for zeiss sem + oxinst ebsd systems.");
disp("Crystal orientation reference axes rotated to match image (Y↓→X).");

%% Import SEM images from second h5oina file
warning off; % suppress h5oina coordinate convention warning
h5Imgs=loadEBSD_h5oina('<str_h5ImgsFile>');
warning(orig_state);

%get pixel size
pixSzImg = double(h5Imgs.opt.Images.Header.X_Step); %pixel length in micrometers

% 1. WC colour contrast - 20mm retracted, lower 3 diodes, rgb
fsdB3 = im2double(cat(3,...
    h5Imgs.opt.Images.Lower_Centre_<str_fsdB3>, ...
    h5Imgs.opt.Images.Lower_Left_<str_fsdB3>,...
    h5Imgs.opt.Images.Lower_Right_<str_fsdB3>...
    ));

% 2. Phase contrast - 20mm retracted, top 2 + lower centre diode, grey
fsdT3 = im2double(mean(cat(3,...
    h5Imgs.opt.Images.Upper_Left_<str_fsdT3>, ...
    h5Imgs.opt.Images.Upper_Right_<str_fsdT3>,...
    h5Imgs.opt.Images.Lower_Centre_<str_fsdT3>...
    ),3));

% 3. Phase contrast - fully inserted, top 2 + lower centre diode, grey
fsdT1 = im2double(mean(cat(3,...
    h5Imgs.opt.Images.Upper_Left_<str_fsdT1>, ...
    h5Imgs.opt.Images.Upper_Right_<str_fsdT1>,...
    h5Imgs.opt.Images.Lower_Centre_<str_fsdT1>...
    ),3));

% 4. Phase contrast - 10kV, fully inserted, top 2 + lower centre diode, grey
fsdT10 = im2double(mean(cat(3,...
    h5Imgs.opt.Images.Upper_Left_<str_fsdT10>, ...
    h5Imgs.opt.Images.Upper_Right_<str_fsdT10>,...
    h5Imgs.opt.Images.Lower_Centre_<str_fsdT10>...
    ),3));

%% Extra user options
% save outputs?
setSave=<str_setSave>;
phaseSegMethod = "<phaseSegMethod>";
flatBseImgLoc = "<flatBseImgLoc>"

%% image preprocessing

% image denoising
fsdB3 = rescale(imboxfilt(fsdB3,<str_filterSize>));
fsdT3 = rescale(imboxfilt(fsdT3,<str_filterSize>));
fsdT1 = rescale(imboxfilt(fsdT1,<str_filterSize>));
fsdT10= rescale(imboxfilt(fsdT10,<str_filterSize>));

%% construct distortedImg list
% edgePadWidth is hard coded here because it's a bit hard to determine
% directly by inspection before resizing all the images

disImgs=createArray(5,1,'distortedImg');
disImgs(1) = distortedImg('bc','shift-drift', ebsd, 'how2plot', pC, 'highContrast',1,'edgePadWidth',3);
disImgs(2) = distortedImg(fsdB3,'true', 'dxy', pixSzImg, 'highContrast',1,'edgePadWidth',5);
disImgs(3) = distortedImg(fsdT3,'shift', 'dxy', pixSzImg, 'highContrast',1,'edgePadWidth',5);
disImgs(4) = distortedImg(fsdT1,'tilt', 'dxy', pixSzImg, 'highContrast',1,'edgePadWidth',5);
disImgs(5) = distortedImg(fsdT10,'true', 'dxy', pixSzImg, 'highContrast',1,'edgePadWidth',3);

%% Uncomment this section if you need to check your images

% you can zoom in and out - tile axes are linked
%{
figure; tiledlayout('flow','TileSpacing','tight','Padding','tight');
for n=1:numel(disImgs)
    nexttile; 
    imagesc('XData',disImgs{n}.dx.*(1:size(disImgs{n}.img,2)),...
        'YData',disImgs{n}.dy*(1:size(disImgs{n}.img,1)),...
        'CData',disImgs{n}.img);
    colormap gray; axis image on ij;
end
linkaxes;
%}
